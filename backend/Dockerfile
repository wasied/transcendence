FROM node:18.14

WORKDIR /app

COPY ./app/package*.json ./
RUN npm ci
COPY ./app ./

# Create .env
ENV APP_URL=${APP_URL}
ENV BACKEND_API_PORT=${BACKEND_API_PORT}
ENV WEBSOCKET_PORT=${WEBSOCKET_PORT}
ENV AUTH_42_AUTH_URL=${AUTH_42_AUTH_URL}
ENV AUTH_42_RETURN_URI=${AUTH_42_RETURN_URI}
ENV AUTH_42_CLIENT_KEY=${AUTH_42_CLIENT_KEY}
ENV AUTH_42_SECRET_KEY=${AUTH_42_SECRET_KEY}
ENV JWT_SECRET=${JWT_SECRET}
ENV POSTGRES_DB_HOST=${POSTGRES_DB_HOST}
ENV POSTGRES_DB_PORT=${POSTGRES_DB_PORT}
ENV POSTGRES_DB_USER=${POSTGRES_DB_USER}
ENV POSTGRES_DB_PASS=${POSTGRES_DB_PASS}
ENV POSTGRES_DB_NAME=${POSTGRES_DB_NAME}

# Run NestJS
RUN npm run build
CMD ["npm", "run", "start:prod"]